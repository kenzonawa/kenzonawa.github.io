
<!DOCTYPE html>
<html>
<head>
	<title>Project 1 - sample code</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js" charset="utf-8"></script>
	<style>
		path {
			stroke: steelblue;
		    stroke-width: 2;
		    fill: none;
		}
    	text { 
			font-family: Arial; 
			font-size: 15px;
		}
		h1{
			font-family: Arial;
		}
		a{
			border-radius: 3px;
			font-family: Arial;
		}
		a:link, a:visited {
		    background-color: #ecf0f1;
		    color: #34495e;
		    padding: 14px 25px;
		    text-align: center;
		    text-decoration: none;
		    display: inline-block;
		}

		a:hover, a:active {
		    background-color: #bdc3c7;
		    color: #2c3e50;
		}
		.axis path, .axis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}
		.tick text {
			fill: black;
			font-size: 11px;
		}
		#fileDiv{
			width:40%;
			display: inline-block;
		}
		#selectionDiv{
			margin-top: 30px;
			height: 100px;
		}
		#addCountry{
			margin-right: 20px;
			margin-left: 50px;
		}
		.container{
			background-color: #ffffff;
		}
		.top-menu{
			padding:20px;
			width: 50%;
			display: inline-block;
		}
		.chart{
			padding:30px;
			border-radius: 4px;
		}
		button {
		    background-color: #e74c3c;
		    border: none;
		    color: white;
		    padding: 7px 20px;
		    text-align: center;
		    display: inline-block;
		    font-size: 14px;
		    margin: 4px 2px;
		    transition-duration: 0.1s;
		    border-radius: 4px;
		    box-shadow: 0 1px 2px 0 rgba(0,0,0,0.24), inset 0 2px 2px 0 rgba(255,255,255,0.19);
		}
		select#fileSelection, select#fileSelection2, select#fileSelection3, select#fileSelection4, select.selection{
		   -webkit-appearance: button;
		   -webkit-border-radius: 2px;
		   -webkit-box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
		   -webkit-padding-end: 20px;
		   -webkit-padding-start: 2px;
		   -webkit-user-select: none;
		   background-image: url(http://i62.tinypic.com/15xvbd5.png), -webkit-linear-gradient(#FAFAFA, #F4F4F4 40%, #E5E5E5);
		   background-position: 97% center;
		   background-repeat: no-repeat;
		   border: 1px solid #AAA;
		   color: #555;
		   font-size: 12px;
		   margin: 5px;
		   overflow: hidden;
		   padding: 5px;
		   text-overflow: ellipsis;
		   white-space: nowrap;
		   width: 237px;
		}
	</style>
</head>
<body>
	<div class="container">
	<div class = "top-menu"> 
		<span class="chart"><a href="#" id = "barChart">Bar Chart</a></span>
		<span class="chart"><a href="#" id = "lineChart">Line Chart</a></span>
		<span class="chart"><a href="#" id = "scatterPlot">Scatter Plot</a></span>
	</div>
	<div id="fileDiv">
	<select id="fileSelection" style="position: relative; left: 0px;">
	  <option value="0">CO2 Emissions/Capita</option>
	  <option value="1">Coal Consumption</option>
	  <option value="2">Coal Production</option>
	  <option value="3">Petroleum Consumption</option>
	  <option value="4">Petroleum Production</option>
	  <option value="5">Renewable Biofuel Consumption</option>
	  <option value="6">Renewable Biofuel Production</option>
	  <option value="7">Renewable Electricity Consumption</option>
	  <option value="8">Renewable Electricity Generation</option>
	  <option value="9">Total Electricity Consumption</option>
	  <option value="10">Total Electricity Generation</option>
	  <option value="11">Total Primary Energy Consumption</option>
	  <option value="12">Total Primary Energy Production</option>
	</select>

	<select id="fileSelection2" style="position: relative; left: 0px;">
	  <option value="0">CO2 Emissions/Capita</option>
	  <option value="1">Coal Consumption</option>
	  <option value="2">Coal Production</option>
	  <option value="3">Petroleum Consumption</option>
	  <option value="4">Petroleum Production</option>
	  <option value="5">Renewable Biofuel Consumption</option>
	  <option value="6">Renewable Biofuel Production</option>
	  <option value="7">Renewable Electricity Consumption</option>
	  <option value="8">Renewable Electricity Generation</option>
	  <option value="9">Total Electricity Consumption</option>
	  <option value="10">Total Electricity Generation</option>
	  <option value="11">Total Primary Energy Consumption</option>
	  <option value="12">Total Primary Energy Production</option>
	</select>

	<select id="fileSelection3" style="position: relative; left: 0px; visibility:hidden;">
	  <option value="0">CO2 Emissions/Capita</option>
	  <option value="1">Coal Consumption</option>
	  <option value="2">Coal Production</option>
	  <option value="3">Petroleum Consumption</option>
	  <option value="4">Petroleum Production</option>
	  <option value="5">Renewable Biofuel Consumption</option>
	  <option value="6">Renewable Biofuel Production</option>
	  <option value="7">Renewable Electricity Consumption</option>
	  <option value="8">Renewable Electricity Generation</option>
	  <option value="9">Total Electricity Consumption</option>
	  <option value="10">Total Electricity Generation</option>
	  <option value="11">Total Primary Energy Consumption</option>
	  <option value="12">Total Primary Energy Production</option>
	</select>

	<select id="fileSelection4" style="position: relative; left: 0px; visibility:hidden;">
	  <option value="0">CO2 Emissions/Capita</option>
	  <option value="1">Coal Consumption</option>
	  <option value="2">Coal Production</option>
	  <option value="3">Petroleum Consumption</option>
	  <option value="4">Petroleum Production</option>
	  <option value="5">Renewable Biofuel Consumption</option>
	  <option value="6">Renewable Biofuel Production</option>
	  <option value="7">Renewable Electricity Consumption</option>
	  <option value="8">Renewable Electricity Generation</option>
	  <option value="9">Total Electricity Consumption</option>
	  <option value="10">Total Electricity Generation</option>
	  <option value="11">Total Primary Energy Consumption</option>
	  <option value="12">Total Primary Energy Production</option>
	</select>
	</div>

	<button id="scatter" style="position: relative; top: 0px; left: 100px; visibility:hidden;"> Scatter! </button>

	<div id="selectionDiv">

	<button id="addCountry" style="background-color: #7f8c8d;"> Add Country </button>

	<select class="selection">	
	</select>

	</div>

	<input type="range" id="myRange" min="0" max="32" value="0" style="visibility:hidden; margin-left: 100px;">

	<svg id="main" class='graph' width="1200" height="250">
		<text id='label' x='100' y='70'></text>
	</svg>

	<svg id="second" class='graph' width="1200" height="250">
		<text id='label' x='100' y='70'></text>
	</svg>
	</div>
	<script>

		var listOfLocalities = [];
		var localities = {};
		var listOfCountries = ['Choose a Country'];
		var localitiesSelected = [];
		var files = ["data/co2_emissions_per_capita.csv", "data/coal_consumption.csv","data/coal_production.csv","data/petroleum_consumption.csv","data/petroleum_production.csv","data/renewable_biofuel_consumption.csv","data/renewable_biofuel_production.csv","data/renewable_electricity_consumption.csv","data/renewable_electricity_generation.csv","data/total_electricity_consumption.csv","data/total_electricity_generation.csv","data/total_primary_energy_consumption.csv","data/total_primary_energy_production.csv"];
		var allResults = [];
		var selectedFile = 0;
		var whichChart = 0;
		var isScatter = false;
		var maxX = 0;
		var maxY = 0;
		var dataset = [];

		d3.selectAll("#barChart")
			.on("click", function(){
				whichChart = 0;
				switchVisibility(0);
				d3.select("#main").selectAll('g').remove();
				d3.select("#second").selectAll('g').remove();
				drawBarChart(localitiesSelected,selectedFile,"#main");
				drawBarChart(localitiesSelected,selectedFile,"#second");
			});

		d3.selectAll("#lineChart")
			.on("click", function(){
				whichChart = 1;
				switchVisibility(0);
				d3.select("#main").selectAll('g').remove();
				d3.select("#second").selectAll('g').remove();
				drawBarChart(localitiesSelected,selectedFile,"#main");
				drawBarChart(localitiesSelected,selectedFile,"#second");
			});

		d3.selectAll("#scatterPlot")
			.on("click", function(){
				isScatter = true;
				switchVisibility(1);
				d3.select("#main").selectAll('g').remove();
				d3.select("#second").selectAll('g').remove();
				storeScatter(1,2);
				drawScatter(0);
				d3.select('#myRange').on('change',function(){
					var x = document.getElementById("myRange").value;
						drawScatter(x);
				});
			});

		d3.select("#fileSelection")
					.on('change', function() {
						d3.select("#main").selectAll('g').remove();
						var e = document.getElementById("fileSelection");
						selectedFile = e.options[e.selectedIndex].value;
						drawBarChart(localitiesSelected,selectedFile,"#main");
					});

		d3.select("#fileSelection2")
					.on('change', function() {
						d3.select("#second").selectAll('g').remove();
						var e = document.getElementById("fileSelection2");
						selectedFile = e.options[e.selectedIndex].value;
						drawBarChart(localitiesSelected,selectedFile,"#second");
					});

		d3.select('#scatter').on('click',function(){
				var file1 = document.getElementById("fileSelection3");
				var selected1 = file1.options[file1.selectedIndex].value;
				var file2 = document.getElementById("fileSelection4");
				var selected2 = file1.options[file2.selectedIndex].value;
				storeScatter(selected1,selected2);
				d3.select("#main").selectAll('g').remove();
				drawScatter(0);
		});
		
		for (var i = 0; i < files.length; i++)
		{
		    Papa.parse(files[i], {
		        download: true,
		        header: true,
		        skipEmptyLines: true,
		        error: function(err, file, inputElem, reason) { /* handle*/ },
		        complete: function(results) {
		            allResults.push(results);
		            if (allResults.length == files.length)
		            {

		            	storeData();

						if (listOfCountries.length == 1 ) listOfCountries = listOfCountries.concat(listOfLocalities);

						//console.log("North America = "+ localities['Spain'].energyProduction[0]);
						//Add Country Button
						d3.select('#addCountry').on('click',function(){
							var myDiv = document.getElementById("selectionDiv");
							selectList = document.createElement("select");
							selectList.className = "selection";
							myDiv.appendChild(selectList);
							countrySelection();
						});
						countrySelection();
						
					}
				}
			});

		}

		//parameter flexible
		function drawBarChart(localityName,fileNumber, svgID)
		{
			var chemical = [];
			var maxProduction = 0;

			//chemical[i] is String. Need to convert to Number
			for ( var i = 0; i < localityName.length ; i++){
				chemical.push(localities[localityName[i]].energyProduction[fileNumber]);
				console.log(d3.max(chemical[i]));
				if (maxProduction < d3.max(chemical[i])) maxProduction = d3.max(chemical[i]);
			}
			

			console.log("localityName = "+ localityName + "max production = "+maxProduction);
			console.log(chemical);
			//var maxProduction = d3.max(d3.max(chemical));

			var chartWidth = 1000;
			var chartHeight = 120;
			var barWidth = chartWidth / (2012-1980+2);
			var z = d3.scale.category10();

			var yScale = d3.scale.linear()
				.domain([0,maxProduction])
				.range([chartHeight,0]);

			var xScale = d3.scale.ordinal()
				.domain(d3.range(chemical[0].length))
				.rangeRoundBands([0,chartWidth], 0.1);

			var x1 = d3.scale.ordinal()
				.domain(d3.range(chemical.length))
				.rangeRoundBands([0, xScale.rangeBand()]);

			var group = d3.select(svgID).append("g")
				.attr("transform", "translate(100, 100)");

			if( whichChart == 1){
				//https://bl.ocks.org/mbostock/3884955
				var line = d3.svg.line()
					.x(function(d,i) { return xScale(i); })
					.y(function(d){ return yScale(d); })
					.interpolate("linear");

				var city = group.selectAll(".city")
				    .data(chemical)
				    .enter().append("g")
				    .attr("class", "city");

				city.append("path")
			        .attr("class", "line")
			        .attr("d", function(d,i) { return line(chemical[i]); })
			        .style("stroke", function(d,i) { return z(i); });
			}
			else {
				//https://bl.ocks.org/mbostock/882152
				group.append("g").selectAll("g")
				    .data(chemical)
				    .enter().append("g")
				    .style("fill", function(d, i) { return z(i); })
				    .attr("transform", function(d, i) { return "translate(" + x1(i) + ",0)"; })
				    .selectAll("rect")
				    .data(function(d) { return d; })
				    .enter().append("rect")
				    .attr("width", x1.rangeBand())
				    .attr("height",function(d){
						return chartHeight - yScale(d);
					})
				    .attr("x", function(d, i) { return xScale(i); })
				    .attr("y", function(d) { return yScale(d); });
			}	

			var timeScale = d3.time.scale()
				.domain([new Date(1980, 1, 1), new Date(2012, 1, 1)])
				.range([0, chartWidth])

			var xAxis = d3.svg.axis()
				.scale(timeScale)
				.orient('bottom');

			group.append("g")
				.attr('class', 'axis')
				.attr('transform', 'translate(0,' + chartHeight + ')')
				.call(xAxis);

			var yAxis = d3.svg.axis()
				.scale(yScale)
				.orient('left');

			group.append("g")
				.attr('class', 'axis')
				.attr('transform', 'translate(-2,0)')
				.call(yAxis);
		}

		function drawScatter(selectedYear)
		{
			//console.log(selectedYear);
			//console.log(dataset[0]);
			var chartWidth = 1000;
			var chartHeight = 120;
			var z = d3.scale.category10();

			var yScale = d3.scale.linear()
				.domain([0,maxY])
				.range([chartHeight,0]);

			var xScale = d3.scale.linear()
				.domain([0,maxX])
				.range([0,chartWidth]);

			var group = d3.select('#main').append("g")
				.attr("transform", "translate(100, 100)");

			//http://bl.ocks.org/WilliamQLiu/bd12f73d0b79d70bfbae
			group.selectAll(".dot")
				      .data(dataset[selectedYear])
				      .enter().append("circle")
				      .attr("class", "dot")
				      .attr("r", 3.5)
				      .attr("cx", function(d,i){
				      	return xScale(d[0]);
				      })
				      .attr("cy", function(d,i){
				      	return yScale(d[1]);
				      })
				      .style("fill", function(d,i) { return z(i); });

			var xAxis = d3.svg.axis()
				.scale(xScale)
				.orient('bottom')
				.ticks(10);

			group.append("g")
				.attr('class', 'axis')
				.attr('transform', 'translate(0,' + chartHeight + ')')
				.call(xAxis);

			var yAxis = d3.svg.axis()
				.scale(yScale)
				.orient('left');

			group.append("g")
				.attr('class', 'axis')
				.attr('transform', 'translate(-2,0)')
				.call(yAxis);

			d3.select('#myRange')
				.on('change',function(){

					var changedYear = document.getElementById("myRange").value;

					group.selectAll(".dot")
				      .data(dataset[changedYear])
				      .transition()
				      .attr("r", 3.5)
				      .attr("cx", function(d,i){
				      	return xScale(d[0]);
				      })
				      .attr("cy", function(d,i){
				      	return yScale(d[1]);
				      })
				      .style("fill", function(d,i) { return z(i); });			
			});
		}

		function countrySelection(){

			// populate selection list
				d3.selectAll('.selection').selectAll('option').data(listOfCountries).enter().append('option')
					.html(function(d) { return d; })
					.attr('value', function(d) { return d; })

				var selection = d3.selectAll(".selection");

				selection.on('change', function() {

						// clear the contents of the chart
						d3.select("#main").selectAll('g').remove();
						d3.select("#second").selectAll('g').remove();

						// figure out the newly selected locality
						var tempLocal = [];
						for (var i = 0; i<selection[0].length ; i++){
							tempLocal.push(selection[0][i].options[selection[0][i].selectedIndex].value);
						}
						localitiesSelected = tempLocal;
						// re-draw bar chart for the new locality
						drawBarChart(localitiesSelected,selectedFile,"#main");
						drawBarChart(localitiesSelected,selectedFile,"#second");
					});
		}

		function storeScatter(file1,file2){

			maxX = 0;
			maxY = 0;

			var chemicalX = [];
			var chemicalY = [];
			
			for (var year = 0 ; year < 32 ; year++){
				chemicalX[year] = new Array();
				chemicalY[year] = new Array();
				dataset[year] = new Array();
				for (var i = 0 ; i< 232; i++){
					chemicalX[year].push(localities[listOfLocalities[i]].energyProduction[file1][year]);
					chemicalY[year].push(localities[listOfLocalities[i]].energyProduction[file2][year]);

					var x = localities[listOfLocalities[i]].energyProduction[file1][year];
					var y = localities[listOfLocalities[i]].energyProduction[file2][year]

					dataset[year].push([x,y]);
				}
				if (maxX < d3.max(chemicalX[year])) maxX = d3.max(chemicalX[year]);
				if (maxY < d3.max(chemicalY[year])) maxY = d3.max(chemicalY[year]);
			}

		}

		function storeData(){
			//loop through all the files
		            	for (var row=0; row < 232; row++)
						{
			            	var locality = {
									name: allResults[0].data[row].Locality,

									energyProduction: new Array(allResults.length)
							}
							// loop through all the rows in file
							for (var currentFile = 0 ; currentFile < allResults.length ; currentFile++)
			            	{

								locality.energyProduction[currentFile] = new Array();

								var record = allResults[currentFile].data[row];

								// loop through all years, from 1980 to 2012
								for (var year=1980; year<=2012; year++) 
								{
									var value = record[year];

									// deal with missing data points
									if (value === '--') {
										value = 0;
									}
									else if (value === 'NA') {
										value = 0;
									}
									else if (value === '(s)') {
										value = 0;
									}
									else if (value === 'W') {
										value = 0;
									}
				
									// add record of current energy production
									locality.energyProduction[currentFile].push( parseFloat(value) );
								}
		
								if (currentFile == 0) listOfLocalities.push( locality.name );
							}

							localities[locality.name] = locality;
							// make bar chart
							//if (localitiesSelected.length == 0 ) drawBarChart(['North America']);
							//else drawBarChart(localitiesSelected);
						}
		}

		function switchVisibility(switchCase){
			if(switchCase == 0)
			{
				document.getElementById("fileSelection").style.visibility = "visible";
				document.getElementById("fileSelection2").style.visibility = "visible";
				document.getElementById("addCountry").style.visibility = "visible";
				d3.selectAll('.selection')
					.style("visibility", "visible");
				document.getElementById("fileSelection3").style.visibility = "hidden";
				document.getElementById("fileSelection4").style.visibility = "hidden";
				document.getElementById("scatter").style.visibility = "hidden";
				document.getElementById("myRange").style.visibility = "hidden";
			}
			else 
			{
				document.getElementById("fileSelection").style.visibility = "hidden";
				document.getElementById("fileSelection2").style.visibility = "hidden";
				document.getElementById("addCountry").style.visibility = "hidden";
				d3.selectAll('.selection')
					.style("visibility", "hidden");
				document.getElementById("fileSelection3").style.visibility = "visible";
				document.getElementById("fileSelection4").style.visibility = "visible";	
				document.getElementById("scatter").style.visibility = "visible";
				document.getElementById("myRange").style.visibility = "visible";	
			}

		}
	</script>
</body>


</html>
